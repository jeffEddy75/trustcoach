// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USERS (NextAuth.js compatible)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// USER
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?   // Hashed, null si OAuth
  role          Role      @default(USER)

  // Relations
  accounts      Account[]
  coach         Coach?
  bookings      Booking[]
  checkIns      CheckIn[]
  consents      Consent[]

  // B2B : Appartenance √† une organisation
  organizations OrganizationMember[]
  goals         Goal[]

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}

enum Role {
  USER      // Client qui r√©serve des s√©ances
  COACH     // Coach qui propose des s√©ances
  ADMIN     // Admin plateforme
}

// ============================================
// COACH
// ============================================

model Coach {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profil public
  bio           String?     @db.Text
  headline      String?     // "Coach en d√©veloppement personnel"
  specialties   String[]    // ["Gestion du stress", "Confiance en soi"]
  languages     String[]    @default(["fr"])

  // =============================================
  // ATTRIBUTS B2B
  // =============================================

  // M√©thodologies certifi√©es (Process Com, MBTI, etc.)
  methodologies     String[]    // ["MBTI", "Process Com", "Enn√©agramme", "360¬∞ Feedback"]

  // Modes d'intervention
  interventionModes InterventionMode[] @default([INDIVIDUAL])

  // Cible client
  targetAudience    TargetAudience[] @default([INDIVIDUAL])

  // Accepte les missions entreprise
  acceptsCorporate  Boolean     @default(false)

  // Tarification
  hourlyRate    Int?        // En centimes (ex: 8000 = 80‚Ç¨)
  dailyRate     Int?        // Tarif journalier B2B (ex: 150000 = 1500‚Ç¨)
  currency      String      @default("EUR")

  // M√©dias
  avatarUrl     String?
  videoUrl      String?     // Vid√©o de pr√©sentation

  // V√©rification & Badge
  verified      Boolean     @default(false)
  badgeLevel    BadgeLevel  @default(STANDARD)
  verifiedAt    DateTime?

  // Localisation
  city          String?
  country       String?     @default("FR")
  timezone      String      @default("Europe/Paris")

  // G√©olocalisation (pour future carte - Phase 5)
  latitude      Float?
  longitude     Float?

  // Modes de coaching
  offersInPerson Boolean    @default(true)
  offersRemote   Boolean    @default(true)

  // Statistiques (d√©normalis√©es pour performance)
  totalSessions Int         @default(0)
  averageRating Float?

  // Relations
  availabilities    Availability[]
  bookings          Booking[]
  consents          Consent[]
  references        CoachReference[]    // R√©f√©rences entreprises
  certifications    Certification[]     // Dipl√¥mes et certifications

  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([verified])
  @@index([specialties])
  @@index([city])
  @@index([acceptsCorporate])
  @@index([methodologies])
}

// =============================================
// ENUMS B2B
// =============================================

enum InterventionMode {
  INDIVIDUAL      // Coaching individuel
  TEAM            // Coaching d'√©quipe
  ORGANIZATION    // Coaching d'organisation
  GROUP           // Ateliers collectifs
}

enum TargetAudience {
  INDIVIDUAL      // Particuliers (B2C)
  EXECUTIVE       // Dirigeants / Cadres sup
  MANAGER         // Managers interm√©diaires
  EMPLOYEE        // Collaborateurs
  ENTREPRENEUR    // Entrepreneurs / Ind√©pendants
}

// =============================================
// R√âF√âRENCES ENTREPRISES
// =============================================

model CoachReference {
  id            String    @id @default(cuid())
  coachId       String
  coach         Coach     @relation(fields: [coachId], references: [id], onDelete: Cascade)

  // Entreprise
  companyName   String    // "LVMH", "BNP Paribas"
  sector        String?   // "Luxe", "Banque"

  // Mission
  missionType   String?   // "Coaching dirigeants", "Accompagnement fusion"
  year          Int?      // Ann√©e de la mission

  // T√©moignage (optionnel, avec accord)
  testimonial   String?   @db.Text
  contactName   String?   // "Marie D., DRH"
  canDisplay    Boolean   @default(true) // Affichable publiquement

  createdAt     DateTime  @default(now())

  @@index([coachId])
}

// =============================================
// CERTIFICATIONS
// =============================================

model Certification {
  id              String    @id @default(cuid())
  coachId         String
  coach           Coach     @relation(fields: [coachId], references: [id], onDelete: Cascade)

  name            String    // "Certification ICF PCC"
  issuer          String    // "International Coaching Federation"
  year            Int?
  expiresAt       DateTime? // Certaines certifications expirent

  // V√©rification
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  documentUrl     String?   // URL du dipl√¥me scann√©

  createdAt       DateTime  @default(now())

  @@index([coachId])
}

enum BadgeLevel {
  STANDARD  // Email v√©rifi√©
  VERIFIED  // Dipl√¥mes v√©rifi√©s manuellement
  PREMIUM   // V√©rifi√© + entretien vid√©o
}

// ============================================
// AVAILABILITY (Disponibilit√©s r√©currentes)
// ============================================

model Availability {
  id          String   @id @default(cuid())
  coachId     String
  coach       Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)

  dayOfWeek   Int      // 0 = Dimanche, 1 = Lundi, ..., 6 = Samedi
  startTime   String   // Format "HH:mm" (ex: "09:00")
  endTime     String   // Format "HH:mm" (ex: "12:00")

  // Optionnel : exceptions de dates
  validFrom   DateTime?
  validUntil  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([coachId])
  @@index([dayOfWeek])
}

// ============================================
// BOOKING (R√©servation)
// ============================================

model Booking {
  id            String        @id @default(cuid())

  // Participants
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  coachId       String
  coach         Coach         @relation(fields: [coachId], references: [id])

  // =============================================
  // B2B : Facturation entreprise
  // =============================================
  billingType   BillingType   @default(INDIVIDUAL)
  organizationId String?      // Si pay√© par une entreprise
  organization  Organization? @relation(fields: [organizationId], references: [id])

  // Planification
  scheduledAt   DateTime      // Date et heure de d√©but
  duration      Int           @default(60) // En minutes
  timezone      String        @default("Europe/Paris")

  // Mode
  mode          BookingMode   @default(REMOTE)
  location      String?       // Adresse si pr√©sentiel
  meetingUrl    String?       // Lien visio si remote

  // Tarification
  price         Int           // En centimes
  currency      String        @default("EUR")

  // Statut
  status        BookingStatus @default(PENDING)
  cancelledAt   DateTime?
  cancelledBy   String?       // userId de celui qui annule
  cancellationReason String?

  // Stripe (paiement direct sur Booking pour simplifier)
  stripeSessionId       String?   // Checkout session ID
  stripePaymentIntentId String?   @unique // Payment intent ID
  paidAt                DateTime? // Date du paiement
  refundedAt            DateTime? // Date du remboursement

  // Relations
  payment       Payment?
  session       Session?

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([coachId])
  @@index([scheduledAt])
  @@index([status])
  @@index([organizationId])
  @@index([billingType])
}

// =============================================
// TYPE DE FACTURATION
// =============================================
enum BillingType {
  INDIVIDUAL    // L'utilisateur paye lui-m√™me
  CORPORATE     // L'entreprise paye (tiers payeur)
}

enum BookingMode {
  REMOTE      // Visioconf√©rence
  IN_PERSON   // Pr√©sentiel
}

enum BookingStatus {
  PENDING          // En attente de paiement
  PAYMENT_FAILED   // √âchec de paiement
  CONFIRMED        // Pay√©, √† venir
  IN_PROGRESS      // S√©ance en cours
  COMPLETED        // S√©ance termin√©e
  CANCELLED        // Annul√©e
  NO_SHOW          // Client absent
  REFUNDED         // Rembours√© int√©gralement
  PARTIALLY_REFUNDED // Rembours√© partiellement
}

// ============================================
// PAYMENT (Paiement Stripe)
// ============================================

model Payment {
  id                String        @id @default(cuid())
  bookingId         String        @unique
  booking           Booking       @relation(fields: [bookingId], references: [id])

  // Stripe
  stripePaymentIntentId String?   @unique
  stripeSessionId       String?

  // Montants
  amount            Int           // En centimes
  platformFee       Int           // Commission plateforme
  coachPayout       Int           // Montant revers√© au coach
  currency          String        @default("EUR")

  // Statut
  status            PaymentStatus @default(PENDING)
  paidAt            DateTime?
  refundedAt        DateTime?
  refundAmount      Int?

  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([stripePaymentIntentId])
}

enum PaymentStatus {
  PENDING     // En attente
  SUCCEEDED   // R√©ussi
  FAILED      // √âchou√©
  REFUNDED    // Rembours√©
  PARTIAL_REFUND // Remboursement partiel
}

// ============================================
// SESSION (S√©ance de coaching + R√©sum√© IA)
// ============================================

model Session {
  id            String        @id @default(cuid())
  bookingId     String        @unique
  booking       Booking       @relation(fields: [bookingId], references: [id])

  // =============================================
  // STATUT DE TRAITEMENT
  // Permet de suivre le pipeline audio ‚Üí r√©sum√©
  // =============================================
  status        SessionStatus @default(IDLE)
  statusMessage String?       // Message d'erreur si FAILED

  // Audio
  audioUrl      String?       // URL S3/Cloudinary
  audioSize     Int?          // Taille en bytes (pour monitoring)
  audioDuration Int?          // Dur√©e en secondes
  audioFormat   String?       // "webm", "mp3", "m4a"

  // Transcription (Whisper)
  transcript    String?       @db.Text
  transcribedAt DateTime?

  // R√©sum√© IA (Claude)
  // =============================================
  // summaryRaw   = Version brute g√©n√©r√©e par l'IA
  // summaryFinal = Version valid√©e/√©dit√©e par le coach
  // =============================================
  summaryRaw    String?       @db.Text
  summaryFinal  String?       @db.Text
  summarizedAt  DateTime?

  // M√©tadonn√©es
  markedMoments MarkedMoment[]

  // Relations
  consents      Consent[]

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([status])
}

// =============================================
// SESSION STATUS
// Pipeline complet de traitement
// =============================================
enum SessionStatus {
  IDLE          // Pas encore d'enregistrement
  RECORDING     // Enregistrement en cours
  UPLOADING     // Upload vers le cloud
  UPLOAD_FAILED // √âchec upload (retry possible)
  TRANSCRIBING  // Transcription Whisper en cours
  TRANSCRIBE_FAILED // √âchec transcription
  SUMMARIZING   // G√©n√©ration r√©sum√© Claude en cours
  SUMMARIZE_FAILED // √âchec r√©sum√©
  COMPLETED     // Tout est termin√©
  FAILED        // √âchec global
}

// ============================================
// MARKED MOMENT (Moments marqu√©s pendant s√©ance)
// ============================================

model MarkedMoment {
  id          String   @id @default(cuid())
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  timestamp   Int      // Secondes depuis le d√©but de l'enregistrement
  type        MomentType @default(IMPORTANT)
  note        String?  // Note optionnelle ajout√©e par l'utilisateur

  // Extrait du transcript (rempli apr√®s transcription)
  excerpt     String?  @db.Text

  createdAt   DateTime @default(now())

  @@index([sessionId])
}

enum MomentType {
  IMPORTANT   // Moment important g√©n√©rique
  INSIGHT     // D√©clic / prise de conscience
  ACTION      // Action √† retenir
  QUOTE       // Citation inspirante
}

// ============================================
// CONSENT (RGPD - Consentements)
// ============================================

model Consent {
  id          String      @id @default(cuid())
  sessionId   String
  session     Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId      String
  user        User        @relation(fields: [userId], references: [id])
  coachId     String
  coach       Coach       @relation(fields: [coachId], references: [id])

  type        ConsentType
  accepted    Boolean     @default(true)

  // RGPD : horodatage pr√©cis
  acceptedAt  DateTime    @default(now())
  ipAddress   String?     // Pour tra√ßabilit√© l√©gale
  userAgent   String?     // Device info

  // R√©vocation
  revokedAt   DateTime?

  @@unique([sessionId, userId, type])
  @@index([sessionId])
  @@index([userId])
}

enum ConsentType {
  AUDIO_RECORDING   // Accepte l'enregistrement audio
  DATA_PROCESSING   // Accepte le traitement par IA
  SUMMARY_SHARING   // Accepte le partage du r√©sum√© avec le coach
  DATA_RETENTION    // Accepte la conservation des donn√©es
}

// ============================================
// CHECK-IN (Suivi quotidien - Phase 5)
// ============================================

model CheckIn {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])

  date        DateTime  @default(now()) @db.Date
  mood        Int       // 1-5 (üòî √† üî•)
  note        String?   @db.Text

  // Actions compl√©t√©es ce jour
  actionsCompleted String[] // IDs des actions coch√©es

  createdAt   DateTime  @default(now())

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================
// B2B : ORGANISATION / ENTREPRISE
// ============================================

model Organization {
  id            String    @id @default(cuid())

  // Informations l√©gales
  name          String    // "Soci√©t√© G√©n√©rale"
  legalName     String?   // "Soci√©t√© G√©n√©rale SA"
  siret         String?   @unique
  vatNumber     String?   // TVA intracommunautaire

  // Adresse de facturation
  billingAddress  String?
  billingCity     String?
  billingPostcode String?
  billingCountry  String?   @default("FR")

  // Contact principal
  contactName   String?
  contactEmail  String?
  contactPhone  String?

  // Param√®tres
  maxUsersAllowed Int?      // Nombre max de coach√©s
  budgetAllocated Int?      // Budget annuel en centimes
  budgetUsed      Int       @default(0)

  // Relations
  members       OrganizationMember[]
  bookings      Booking[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([name])
}

// Lien User <-> Organisation (un user peut appartenir √† une orga)
model OrganizationMember {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  role            OrgMemberRole @default(EMPLOYEE)

  // Limites individuelles
  sessionsAllowed Int?      // Nombre de s√©ances autoris√©es
  sessionsUsed    Int       @default(0)

  joinedAt        DateTime  @default(now())

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

enum OrgMemberRole {
  ADMIN       // RH / Administrateur du compte entreprise
  MANAGER     // Peut voir les stats de son √©quipe
  EMPLOYEE    // Coach√© simple
}

// ============================================
// OBJECTIFS & KPIs
// Permet de mesurer l'√©volution concr√®te du coach√©
// ============================================

model Goal {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])

  // Optionnel : li√© √† une mission entreprise
  organizationId String?

  // Contenu
  title         String    // "Am√©liorer ma prise de parole en public"
  description   String?   @db.Text
  category      GoalCategory @default(PERSONAL)

  // Mesure
  targetValue   Float?    // Valeur cible (ex: 8/10)
  currentValue  Float?    // Valeur actuelle
  unit          String?   // "score /10", "%", "occurrences/semaine"

  // Dates
  startDate     DateTime  @default(now())
  targetDate    DateTime?
  completedAt   DateTime?

  // Statut
  status        GoalStatus @default(IN_PROGRESS)

  // Historique des mesures
  measurements  GoalMeasurement[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

enum GoalCategory {
  PERSONAL      // Objectif personnel (B2C)
  PROFESSIONAL  // Objectif pro (B2B)
  ORGANIZATIONAL // Objectif d√©fini par l'entreprise
}

enum GoalStatus {
  DRAFT         // Brouillon
  IN_PROGRESS   // En cours
  COMPLETED     // Atteint
  ABANDONED     // Abandonn√©
}

// Historique des mesures d'un objectif
model GoalMeasurement {
  id          String    @id @default(cuid())
  goalId      String
  goal        Goal      @relation(fields: [goalId], references: [id], onDelete: Cascade)

  value       Float     // Valeur mesur√©e
  note        String?   // Commentaire
  measuredAt  DateTime  @default(now())

  // Li√© √† une s√©ance ?
  sessionId   String?

  @@index([goalId])
}

// ============================================
// DOCUMENTS DE TRAVAIL COACH
// Tests de personnalit√©, √©valuations 360¬∞, etc.
// ============================================

model CoachDocument {
  id            String    @id @default(cuid())

  // Propri√©taire
  coachId       String?   // Si upload√© par le coach
  userId        String?   // Si upload√© par le coach√©
  sessionId     String?   // Si li√© √† une s√©ance sp√©cifique

  // Fichier
  name          String    // "Test MBTI - Jean Dupont"
  type          DocumentType
  fileUrl       String
  fileSize      Int       // En bytes
  mimeType      String    // "application/pdf"

  // Analyse IA (optionnel)
  aiSummary     String?   @db.Text // R√©sum√© g√©n√©r√© par l'IA
  aiAnalyzedAt  DateTime?

  // Partage
  sharedWithCoach Boolean @default(false)
  sharedWithUser  Boolean @default(false)

  // Confidentialit√©
  isConfidential Boolean  @default(true)
  expiresAt      DateTime? // Auto-suppression apr√®s X jours

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([coachId])
  @@index([userId])
  @@index([sessionId])
}

enum DocumentType {
  PERSONALITY_TEST  // MBTI, Process Com, etc.
  EVALUATION_360    // Feedback 360¬∞
  PERFORMANCE_REVIEW // Entretien annuel
  CUSTOM            // Autre document
  SESSION_NOTES     // Notes de s√©ance (manuscrites)
}

// ============================================
// OFFLINE QUEUE (File d'attente hors-ligne)
// Tracker les uploads en attente c√¥t√© serveur
// ============================================

model OfflineUpload {
  id            String            @id @default(cuid())
  sessionId     String

  // Tracking
  status        OfflineUploadStatus @default(PENDING)
  retryCount    Int               @default(0)
  lastRetryAt   DateTime?
  errorMessage  String?

  // M√©tadonn√©es de l'upload
  fileSize      Int               // Taille attendue
  checksum      String?           // Pour v√©rifier l'int√©grit√©

  createdAt     DateTime          @default(now())
  completedAt   DateTime?

  @@index([status])
  @@index([sessionId])
}

enum OfflineUploadStatus {
  PENDING       // En attente de connexion
  UPLOADING     // Upload en cours
  COMPLETED     // Upload r√©ussi
  FAILED        // √âchec d√©finitif (apr√®s X retries)
}
